go run main.go import --project-id=world-fishing-827 --query="WITH shipnames_aggregated AS (SELECT vessel_id, STRUCT (value AS name, SUM(count) AS counter) as aggr_shipnames, FROM \`world-fishing-827.pipe_production_v20190502.research_aggregated_segments\` ras INNER JOIN \`world-fishing-827.pipe_production_v20190502.segment_vessel\` USING (seg_id), UNNEST(shipname) GROUP BY vessel_id, value), shipnames_grouped AS (SELECT vessel_id, ARRAY_AGG(aggr_shipnames) as shipnames FROM shipnames_aggregated GROUP BY vessel_id), imos_aggregated as (SELECT vessel_id, STRUCT (value AS name, SUM(count) AS counter) as aggr_imos,FROM \`world-fishing-827.pipe_production_v20190502.research_aggregated_segments\` ras INNER JOIN \`world-fishing-827.pipe_production_v20190502.segment_vessel\` USING (seg_id), UNNEST(imo) GROUP BY vessel_id, value),imos_grouped as (SELECT vessel_id, ARRAY_AGG(aggr_imos) as imos FROM imos_aggregated GROUP BY vessel_id), callsigns_aggregated as (SELECT vessel_id, STRUCT (value AS name, SUM(count) AS counter) as aggr_callsign, FROM \`world-fishing-827.pipe_production_v20190502.research_aggregated_segments\` ras INNER JOIN \`world-fishing-827.pipe_production_v20190502.segment_vessel\` USING (seg_id), UNNEST(callsign) GROUP BY vessel_id, value), callsigns_grouped AS (SELECT vessel_id, ARRAY_AGG(aggr_callsign) as callsigns FROM callsigns_aggregated GROUP BY vessel_id), aggregated_data AS (SELECT sg.vessel_id, shipnames, imos, callsigns FROM shipnames_grouped sg INNER JOIN imos_grouped ig USING (vessel_id)INNER JOIN callsigns_grouped cg USING (vessel_id)) SELECT vi.vessel_id AS id, \`world-fishing-827.udfs.mmsi_to_iso3\`(vi.ssvid) AS flag, vi.ssvid as mmsi, vi.first_timestamp as first_transmission_date, vi.last_timestamp as last_transmission_date, if(vi.n_imo.value is null, null, vi.imo.value) as imo, if(vi.n_callsign.value is null, null, vi.callsign.value) as callsign, if(vi.n_shipname.value is null, null, vi.shipname.value) as shipname, ad.shipnames as other_shipnames, ad.imos as other_imos, ad.callsigns as other_callsigns FROM aggregated_data ad INNER JOIN \`world-fishing-827.pipe_production_v20190502.vessel_info\` vi USING (vessel_id) WHERE vi.shipname.value IS NOT null AND vi.n_shipname IS NOT null" --index-name=gfw-vessels_2020-10-15 --elastic-search-url=https://gfw:fishingvessel@elasticsearch.globalfishingwatch.org --on-error=delete